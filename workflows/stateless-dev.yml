# Stateless Development Workflow
# æ— çŠ¶æ€å¼€å‘å·¥ä½œæµ - åŸå­ä»»åŠ¡ + çŠ¶æ€æ–‡ä»¶ + ç‹¬ç«‹ä¼šè¯
# Version: 2.0.0

name: "Stateless Development Workflow"
description: "Context-efficient workflow using isolated sessions and file-based state"
version: "2.0.0"

# ============================================
# æ ¸å¿ƒåŸåˆ™
# ============================================
# 1. æ¯ä¸ªåŸå­ä»»åŠ¡ä½¿ç”¨ç‹¬ç«‹ä¼šè¯
# 2. é€šè¿‡æ–‡ä»¶ä¼ é€’çŠ¶æ€ï¼Œä¸ä¾èµ–å¯¹è¯å†å²
# 3. æ¯ä¸ªä»»åŠ¡å®Œæˆåä½¿ç”¨ /clear æ¸…é™¤ä¸Šä¸‹æ–‡
# 4. å•ä¸ªä»»åŠ¡ä¸Šä¸‹æ–‡ä½¿ç”¨ç‡ä¸è¶…è¿‡ 80%

# ============================================
# é…ç½®
# ============================================
config:
  # ä¼šè¯æ¨¡å¼
  session_mode: "isolated"          # æ¯ä¸ªä»»åŠ¡ç‹¬ç«‹ä¼šè¯

  # ä¸Šä¸‹æ–‡é™åˆ¶
  context:
    max_per_task: 80                # å•ä»»åŠ¡æœ€å¤§ 80% ä¸Šä¸‹æ–‡
    warning_threshold: 60           # 60% æ—¶è­¦å‘Š

  # çŠ¶æ€ç®¡ç†
  state:
    enabled: true
    directory: ".claude/state"
    current_file: "current-session.md"
    backup_enabled: true
    backup_frequency: "per_task"

  # ä»»åŠ¡åŸå­åŒ–
  atomic_task:
    max_duration_minutes: 30
    max_files: 3
    single_responsibility: true

# ============================================
# å·¥ä½œæµæ­¥éª¤
# ============================================
steps:
  # ============================================
  # Step 0: åˆå§‹åŒ–ä¼šè¯çŠ¶æ€
  # ============================================
  - id: "init-session"
    name: "åˆå§‹åŒ–ä¼šè¯çŠ¶æ€"
    description: "åˆ›å»ºæˆ–åŠ è½½ä¼šè¯çŠ¶æ€æ–‡ä»¶"

    actions:
      - type: "check_state_file"
        file: ".claude/state/current-session.md"

      - type: "create_if_not_exists"
        file: ".claude/state/current-session.md"
        template: ".claude/templates/session-state.md"

      - type: "load_state"
        from: ".claude/state/current-session.md"

      - type: "notify"
        message: |
          âœ… ä¼šè¯çŠ¶æ€å·²åŠ è½½

          å½“å‰è¿›åº¦: {completed_tasks}/{total_tasks} ä»»åŠ¡
          ä¸‹ä¸€ä»»åŠ¡: {next_task.id} - {next_task.name}

  # ============================================
  # Step 1-3: éœ€æ±‚æ¾„æ¸…ã€æŠ€æœ¯åˆ†æã€è®¡åˆ’ç”Ÿæˆ
  # ï¼ˆä¸ä¹‹å‰çš„ dev.yml ç›¸åŒï¼Œè¿™é‡Œçœç•¥ï¼‰
  # ============================================

  # ============================================
  # Step 4: ä»»åŠ¡æ‰§è¡Œå¾ªç¯ï¼ˆæ— çŠ¶æ€æ¨¡å¼ï¼‰
  # ============================================
  - id: "execute-tasks-stateless"
    name: "ä»»åŠ¡æ‰§è¡Œï¼ˆæ— çŠ¶æ€æ¨¡å¼ï¼‰"
    description: "æ¯ä¸ªä»»åŠ¡ä½¿ç”¨ç‹¬ç«‹ä¼šè¯ï¼Œé€šè¿‡æ–‡ä»¶ä¼ é€’çŠ¶æ€"

    mode: "stateless"
    loop: true
    for_each: "task in atomic_tasks"

    # ----------------------------------------
    # ä»»åŠ¡å‰ç½®æ“ä½œ
    # ----------------------------------------
    before_task:
      # 1. æ£€æŸ¥ä¸Šä¸‹æ–‡ä½¿ç”¨ç‡
      - action: "check_context"
        threshold: 80
        on_exceed:
          action: "abort"
          message: "âš ï¸ ä¸Šä¸‹æ–‡å·²è¶…è¿‡ 80%ï¼Œè¯·å…ˆå®Œæˆå½“å‰ä»»åŠ¡"

      # 2. åŠ è½½çŠ¶æ€æ–‡ä»¶
      - action: "load_state"
        files:
          - ".claude/state/current-session.md"
          - "./CLAUDE.md"
          - ".claude/specs/atomic-tasks.md"

        prompt: |
          è¯·é˜…è¯»ä»¥ä¸‹æ–‡ä»¶äº†è§£å½“å‰é¡¹ç›®çŠ¶æ€ï¼š

          1. **ä¼šè¯çŠ¶æ€**: `.claude/state/current-session.md`
             - å½“å‰è¿›åº¦
             - å·²å®Œæˆä»»åŠ¡çš„è¾“å‡º
             - ä»»åŠ¡é—´ä¾èµ–æ•°æ®

          2. **é¡¹ç›®ä¸Šä¸‹æ–‡**: `./CLAUDE.md`
             - é¡¹ç›®ä¿¡æ¯
             - æŠ€æœ¯æ ˆ
             - å¼€å‘è§„èŒƒ

          3. **ä»»åŠ¡åˆ—è¡¨**: `.claude/specs/atomic-tasks.md`
             - æ‰€æœ‰ä»»åŠ¡è§„èŒƒ
             - ä¾èµ–å…³ç³»

      # 3. åŠ è½½å½“å‰ä»»åŠ¡è§„èŒƒ
      - action: "load_task_spec"
        file: ".claude/specs/task-{task.id}.md"

        prompt: |
          ç°åœ¨å¼€å§‹æ‰§è¡Œï¼š

          **ä»»åŠ¡ ID**: {task.id}
          **ä»»åŠ¡åç§°**: {task.name}
          **ä»»åŠ¡è§„èŒƒ**: è§ `.claude/specs/task-{task.id}.md`

          è¯·æŒ‰ç…§ä»»åŠ¡è§„èŒƒæ‰§è¡Œã€‚

    # ----------------------------------------
    # ä»»åŠ¡æ‰§è¡Œ
    # ----------------------------------------
    execute:
      # ä¸Šä¸‹æ–‡ç›‘æ§
      context_monitoring:
        enabled: true
        check_interval: "per_action"

        on_warning:  # 60%
          action: "notify"
          message: "âš ï¸ ä¸Šä¸‹æ–‡ä½¿ç”¨ç‡ {usage}%ï¼Œè¯·å°½å¿«å®Œæˆä»»åŠ¡"

        on_critical:  # 80%
          action: "abort"
          message: |
            ğŸš¨ ä¸Šä¸‹æ–‡ä½¿ç”¨ç‡å·²è¾¾ {usage}%

            è¯·ç«‹å³ï¼š
            1. ä¿å­˜å½“å‰è¿›åº¦åˆ°çŠ¶æ€æ–‡ä»¶
            2. å®Œæˆå½“å‰ä»»åŠ¡çš„æœ€åæ­¥éª¤
            3. ä¸è¦å¼€å§‹æ–°çš„å­ä»»åŠ¡

      # ä»»åŠ¡æ‰§è¡Œæ­¥éª¤ï¼ˆä¸ä¹‹å‰ç›¸åŒï¼‰
      steps:
        - id: "get-prototype"
          # ... (ä¸ä¹‹å‰ç›¸åŒ)

        - id: "implement"
          # ... (ä¸ä¹‹å‰ç›¸åŒ)

        - id: "code-review"
          # ... (ä¸ä¹‹å‰ç›¸åŒ)

        - id: "fix-issues"
          # ... (ä¸ä¹‹å‰ç›¸åŒ)

    # ----------------------------------------
    # ä»»åŠ¡åç½®æ“ä½œï¼ˆå…³é”®ï¼ï¼‰
    # ----------------------------------------
    after_task:
      # 1. ä¿å­˜ä»»åŠ¡è¾“å‡ºåˆ°çŠ¶æ€æ–‡ä»¶
      - action: "save_task_output"
        file: ".claude/state/current-session.md"

        update_sections:
          # æ›´æ–°ä»»åŠ¡çŠ¶æ€è¡¨
          - section: "ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€"
            update: |
              | {task.id} | {task.name} | âœ… å®Œæˆ | {timestamp} |

          # æ›´æ–°ä»»åŠ¡è¾“å‡º
          - section: "ä»»åŠ¡è¾“å‡º"
            append: |
              ### Task {task.id}: {task.name}

              **å®Œæˆæ—¶é—´**: {timestamp}

              **è¾“å‡ºæ–‡ä»¶**:
              {task.output_files}

              **å…³é”®å†³ç­–**:
              {task.key_decisions}

              **ä¼ é€’ç»™ä¸‹ä¸€ä»»åŠ¡çš„æ•°æ®**:
              ```
              {task.transfer_data}
              ```

      # 2. æ›´æ–°è¿›åº¦æ–‡ä»¶
      - action: "update_progress"
        file: ".claude/progress/progress.md"

        update:
          completed_count: "{completed_count + 1}"
          current_task: "{next_task.id}"

      # 3. æ›´æ–° CLAUDE.md
      - action: "update_memory"
        file: "./CLAUDE.md"

        update_section: "## å½“å‰è¿›åº¦ (è‡ªåŠ¨æ›´æ–°)"
        content: |
          **æœ€åæ›´æ–°**: {timestamp}
          **å½“å‰ä»»åŠ¡**: {next_task.id}
          **å®Œæˆè¿›åº¦**: {completed_count}/{total_count}

          **æœ€è¿‘å®Œæˆ**: Task {task.id} - {task.name}
          **ä¸‹ä¸€ä»»åŠ¡**: Task {next_task.id} - {next_task.name}

      # 4. å¤‡ä»½çŠ¶æ€æ–‡ä»¶
      - action: "backup_state"
        from: ".claude/state/current-session.md"
        to: ".claude/state/backups/session-{timestamp}.md"

      # 5. æç¤ºç”¨æˆ·æ¸…é™¤ä¸Šä¸‹æ–‡
      - action: "notify"
        message: |
          âœ… Task {task.id} å·²å®Œæˆ

          **ä»»åŠ¡çŠ¶æ€å·²ä¿å­˜åˆ°**:
          - `.claude/state/current-session.md`
          - `./CLAUDE.md`

          **ä¸‹ä¸€æ­¥æ“ä½œ**:
          1. è¯·æ‰§è¡Œ `/clear` æ¸…é™¤å½“å‰ä¸Šä¸‹æ–‡
          2. ç„¶åç»§ç»­æ‰§è¡Œä¸‹ä¸€ä»»åŠ¡

          **ä¸‹ä¸€ä»»åŠ¡**: Task {next_task.id} - {next_task.name}

          **æç¤ºè¯**:
          ```
          è¯·é˜…è¯» .claude/state/current-session.md å’Œ ./CLAUDE.md äº†è§£å½“å‰è¿›åº¦ï¼Œ
          ç„¶åæ‰§è¡Œ Task {next_task.id}: {next_task.name}
          ```

      # 6. ç­‰å¾…ç”¨æˆ·æ¸…é™¤ä¸Šä¸‹æ–‡
      - action: "pause"
        wait_for: "user_clear_context"

        instructions: |
          è¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œç»§ç»­ï¼š

          1. è¾“å…¥ `/clear` æ¸…é™¤ä¸Šä¸‹æ–‡
          2. å¤åˆ¶ä¸Šé¢çš„æç¤ºè¯
          3. å¼€å§‹æ–°çš„å¯¹è¯

    # ----------------------------------------
    # é”™è¯¯å¤„ç†
    # ----------------------------------------
    on_error:
      - action: "save_error_state"
        file: ".claude/state/error-{timestamp}.md"
        content: |
          # é”™è¯¯çŠ¶æ€

          **ä»»åŠ¡**: {task.id} - {task.name}
          **é”™è¯¯æ—¶é—´**: {timestamp}
          **é”™è¯¯ä¿¡æ¯**: {error.message}

          **å½“å‰çŠ¶æ€**:
          {current_state}

          **æ¢å¤æ­¥éª¤**:
          1. æ£€æŸ¥é”™è¯¯ä¿¡æ¯
          2. ä¿®å¤é—®é¢˜
          3. ä» `.claude/state/current-session.md` æ¢å¤çŠ¶æ€
          4. é‡æ–°æ‰§è¡Œä»»åŠ¡ {task.id}

      - action: "notify"
        message: |
          âŒ Task {task.id} æ‰§è¡Œå¤±è´¥

          é”™è¯¯çŠ¶æ€å·²ä¿å­˜åˆ°: `.claude/state/error-{timestamp}.md`

          è¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯å¹¶ä¿®å¤åé‡è¯•ã€‚

  # ============================================
  # Step 5: å®Œæˆå·¥ä½œæµ
  # ============================================
  - id: "complete-workflow"
    name: "å®Œæˆå·¥ä½œæµ"
    description: "æ‰€æœ‰ä»»åŠ¡å®Œæˆåçš„æ¸…ç†å·¥ä½œ"
    condition: "all_tasks_complete"

    actions:
      - action: "archive_state"
        from: ".claude/state/current-session.md"
        to: ".claude/state/completed/session-{project_name}-{timestamp}.md"

      - action: "generate_report"
        file: ".claude/reports/completion-report.md"
        template: ".claude/templates/completion-report.md"

      - action: "notify"
        message: |
          ğŸ‰ æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼

          **å®ŒæˆæŠ¥å‘Š**: `.claude/reports/completion-report.md`
          **çŠ¶æ€å½’æ¡£**: `.claude/state/completed/`

          è¯·è¿›è¡Œæœ€ç»ˆéªŒæ”¶æµ‹è¯•ã€‚

# ============================================
# çŠ¶æ€æ–‡ä»¶ç»“æ„å®šä¹‰
# ============================================
state_schema:
  current_session:
    file: ".claude/state/current-session.md"
    sections:
      - name: "ä¼šè¯å…ƒæ•°æ®"
        required: true
        fields:
          - session_id
          - start_time
          - last_update
          - current_task_id

      - name: "å…¨å±€ä¸Šä¸‹æ–‡"
        required: true
        fields:
          - project_name
          - project_type
          - tech_stack
          - key_decisions

      - name: "ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€"
        required: true
        format: "table"
        columns:
          - task_id
          - task_name
          - status
          - completion_time

      - name: "ä»»åŠ¡è¾“å‡º"
        required: true
        format: "markdown"
        content: "æ¯ä¸ªä»»åŠ¡çš„è¾“å‡ºå’Œå…³é”®ä¿¡æ¯"

      - name: "ä»»åŠ¡é—´ä¾èµ–æ•°æ®"
        required: true
        format: "code_blocks"
        content: "éœ€è¦ä¼ é€’ç»™ä¸‹ä¸€ä»»åŠ¡çš„æ•°æ®"

      - name: "ä¸‹ä¸€ä»»åŠ¡é¢„è§ˆ"
        required: true
        fields:
          - next_task_id
          - next_task_name
          - dependencies

# ============================================
# ä½¿ç”¨è¯´æ˜
# ============================================
usage:
  initialization: |
    # åˆå§‹åŒ–å·¥ä½œæµ
    1. ç¡®ä¿ .claude/ ç›®å½•å­˜åœ¨
    2. è¿è¡Œå·¥ä½œæµ: /workflow run stateless-dev
    3. æŒ‰ç…§æç¤ºå®Œæˆéœ€æ±‚æ¾„æ¸…å’Œä»»åŠ¡è§„åˆ’

  task_execution: |
    # æ‰§è¡Œä»»åŠ¡
    1. å·¥ä½œæµä¼šæç¤ºä½ æ‰§è¡Œä»»åŠ¡
    2. ä»»åŠ¡å®Œæˆåï¼Œæ‰§è¡Œ /clear
    3. å¤åˆ¶æç¤ºè¯ï¼Œå¼€å§‹æ–°å¯¹è¯
    4. é‡å¤ç›´åˆ°æ‰€æœ‰ä»»åŠ¡å®Œæˆ

  state_recovery: |
    # æ¢å¤çŠ¶æ€
    å¦‚æœä¼šè¯ä¸­æ–­ï¼š
    1. è¯»å– .claude/state/current-session.md
    2. æ‰¾åˆ°å½“å‰ä»»åŠ¡ ID
    3. ç»§ç»­æ‰§è¡Œè¯¥ä»»åŠ¡

  troubleshooting: |
    # æ•…éšœæ’é™¤
    - çŠ¶æ€æ–‡ä»¶æŸå: ä» .claude/state/backups/ æ¢å¤
    - ä»»åŠ¡å¤±è´¥: æŸ¥çœ‹ .claude/state/error-*.md
    - ä¸Šä¸‹æ–‡æº¢å‡º: æ£€æŸ¥ä»»åŠ¡æ˜¯å¦è¿‡å¤§ï¼Œè€ƒè™‘æ‹†åˆ†
