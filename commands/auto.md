---
description: 自动执行完整工作流（一键完成所有阶段）
---

# 自动化工作流

⚠️ **强制执行完整流程** - 此命令将自动执行 Phase 0 → Phase 5 所有阶段，确保工作流完整性。

## 🎯 工作流强制执行

此命令会：
1. ✅ 初始化 workflow-state.json 状态追踪
2. ✅ 强制执行所有 Phase（不可跳过）
3. ✅ 在 Phase 2 和 Phase 5 暂停等待确认
4. ✅ 自动保存状态和上下文管理

## 执行流程

### 🔄 Phase 0-1: 准备阶段（自动）

**状态更新**: 写入 workflow-state.json: `current_phase: "Phase 0"`

1. **检查上下文使用率** (必需)
   - 调用 `check_context_usage` 工具
   - 降级方案: 如 MCP 失败，手动计算
   - 如使用率 > 70%，先保存状态并建议 `/clear`

2. **搜索相关代码** (必需)
   - 使用 `search_code_advanced` 或 Grep + Read
   - 获取完整代码上下文

**状态更新**: 标记 Phase 0-1 完成

### ⏸️ Phase 2: 分析阶段（暂停确认）

**状态更新**: `current_phase: "Phase 2"`

3. **多模型协作分析** (必需)
   - 并行调用 Codex 和 Gemini
   - 降级方案: 如 Skills 不可用，Claude 单独分析
   - 交叉验证输出

4. **展示实施方案并等待确认** (必需)
   - 显示技术方案、风险、步骤
   - ⏸️ **暂停**: 等待用户输入 "继续" / "修改" / "取消"

**状态更新**: 标记 Phase 2 完成

### 🔄 Phase 3-4: 实施阶段（自动）

**状态更新**: `current_phase: "Phase 3-4"`

5. **原子任务拆分与实施** (必需)
   - 强制拆分为原子任务（每个任务只做一件事）
   - 使用 TodoWrite 记录所有任务
   - **每完成 1 个原子任务**:
     * 立即标记 completed
     * 检查上下文使用率
     * 如 > 70%: 保存状态 → 提示 `/clear` → 暂停
   - **每 5-10 个工具调用**: 自动检查上下文
   - Claude 重构为生产代码
   - **目标**: 纯净上下文，减少幻觉，节省 Token

**状态更新**: 标记 Phase 3-4 完成

### ⏸️ Phase 5: 审计阶段（暂停确认）

**状态更新**: `current_phase: "Phase 5"`

6. **双模型代码审计** (必需)
   - 并行调用 Codex 和 Gemini 审计
   - 降级方案: Claude 单独审计
   - 生成审计报告

7. **展示审计结果并等待确认** (必需)
   - 显示问题和建议
   - ⏸️ **暂停**: 等待用户输入 "应用修复" / "忽略" / "手动修改"

**状态更新**: 标记 Phase 5 完成，清空 workflow-state.json

## 优势

- ✅ **一个命令完成所有步骤** - 无需记忆 6 个阶段
- ✅ **在关键点暂停确认** - 保持人工控制
- ✅ **自动化上下文管理** - 无需手动检查
- ✅ **并行执行提升性能** - 多模型调用并行化
- ✅ **降低学习成本** - 新用户友好

## 使用方法

```bash
# 基本用法
/cm:auto 实现用户认证功能

# 带详细描述
/cm:auto 添加 JWT 认证，支持 token 刷新和权限验证
```

## 与手动模式对比

| 特性 | 手动模式 | 自动模式 |
|------|---------|---------|
| 命令数量 | 6 个 | 1 个 |
| 学习成本 | 高 | 低 |
| 控制粒度 | 细粒度 | 关键点 |
| 适用场景 | 复杂任务 | 常规任务 |
| 上下文管理 | 手动 | 自动 |

## 注意事项

- 自动模式会在 Phase 2 和 Phase 5 暂停等待确认
- 如果任务特别复杂，建议使用手动模式以获得更多控制
- 上下文使用率会自动监控，无需手动检查

**ARGUMENTS**: $1
