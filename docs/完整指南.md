# Context Monitor 完整指南

> 智能化的 Claude Code 开发工作流系统

## 目录

- [快速开始](#快速开始)
- [系统概述](#系统概述)
- [安装配置](#安装配置)
- [工作流详解](#工作流详解)
- [使用指南](#使用指南)
- [故障排除](#故障排除)

---

## 快速开始

### 插件安装（推荐）

```bash
# 1. 添加 marketplace
/plugin marketplace add https://github.com/wuciqiang/context-monitor

# 2. 安装插件
/plugin install cm

# 3. 验证安装
/cm:check
```

### 基本使用

```bash
# 启动工作流
/cm:start

# 分析任务
/cm:analyze 实现用户认证功能

# 开始实施
/cm:implement

# 代码审计
/cm:audit
```

---

## 系统概述

### 核心价值

Context Monitor 解决 AI 辅助开发中的五大核心问题：

1. **上下文管理混乱** → 自动监控 + 状态保存
2. **工作流不一致** → 强制执行标准流程
3. **代码搜索低效** → 自然语言查询 + 深度索引
4. **单一模型局限** → 多模型协作机制
5. **缺乏质量保障** → 双模型审计系统

### 技术架构

```
┌─────────────────────────────────────────┐
│         Claude Code Plugin (cm)         │
│  /cm:start | analyze | implement | audit│
└─────────────┬───────────────────────────┘
              │
    ┌─────────┴─────────┐
    │                   │
┌───▼────────┐    ┌────▼─────────┐
│ Context    │    │ Code Index   │
│ Monitor    │    │ MCP Server   │
│ MCP Server │    │              │
└────────────┘    └──────────────┘
    │                   │
    └─────────┬─────────┘
              │
    ┌─────────▼─────────┐
    │  Codex & Gemini   │
    │  Skills           │
    └───────────────────┘
```

---

## 安装配置

### 方式一：插件安装（推荐）

**优点**：一键安装，自动配置，适合快速上手

```bash
/plugin marketplace add https://github.com/wuciqiang/context-monitor
/plugin install cm
```

### 方式二：项目级安装

**优点**：完全控制，适合团队协作

#### 1. 克隆仓库

```bash
git clone https://github.com/wuciqiang/context-monitor.git
cd context-monitor
```

#### 2. 运行安装脚本

**Windows (PowerShell)**:
```powershell
.\scripts\install-to-project.ps1 -ProjectPath "E:\YourProject"
```

**Linux/Mac**:
```bash
./scripts/install-to-project.sh /path/to/your/project
```

#### 3. 配置 MCP 服务器

在项目根目录创建 `.mcp.json`：

```json
{
  "mcpServers": {
    "context-monitor": {
      "type": "stdio",
      "command": "npx",
      "args": ["-y", "@anthropic-ai/context-monitor-mcp"]
    },
    "code-index": {
      "type": "stdio",
      "command": "npx",
      "args": ["-y", "@anthropic-ai/code-index-mcp"]
    }
  }
}
```

#### 4. 安装 Skills

**Codex**:
```bash
/skill install collaborating-with-codex
```

**Gemini**:
```bash
/skill install collaborating-with-gemini
```

### 方式三：全局安装

**优点**：所有项目共享，适合个人开发者

```powershell
# Windows
.\scripts\install-global.ps1

# Linux/Mac
./scripts/install-global.sh
```

### Windows 编码配置（重要）

Windows 用户必须配置 UTF-8 编码，否则 Codex/Gemini 会报错。

**方法 1：项目级配置**

在 `.claude/settings.local.json` 中添加：

```json
{
  "env": {
    "PYTHONIOENCODING": "utf-8",
    "PYTHONUTF8": "1"
  }
}
```

**方法 2：全局配置**

在 PowerShell 中运行：

```powershell
[System.Environment]::SetEnvironmentVariable("PYTHONIOENCODING", "utf-8", "User")
[System.Environment]::SetEnvironmentVariable("PYTHONUTF8", "1", "User")
```

重启 Claude Code 生效。

---

## 工作流详解

### Phase 0：初始化与上下文检查

**命令**：`/cm:start`

**任务**：
- 检查上下文使用率（确保 < 50%）
- 初始化代码索引（首次使用）
- 配置文件监控服务

**输出**：上下文状态报告

**为什么重要**：在健康状态下开始工作，避免会话崩溃。

---

### Phase 1：上下文全量检索

**命令**：`/cm:start`（自动执行）

**任务**：
- 使用自然语言查询代码库
- 获取完整的类、函数、变量定义
- 递归检索依赖关系

**约束**：
- ❌ 禁止使用关键词搜索（grep）
- ❌ 禁止基于假设回答
- ✅ 必须获取完整定义

**输出**：完整的代码上下文

**为什么重要**：不完整的上下文是 AI 犯错的主要原因。

---

### Phase 2：多模型协作分析

**命令**：`/cm:analyze [任务描述]`

**任务**：
1. 检查上下文使用率（> 70% 则简化或保存）
2. 分发需求给 Codex 和 Gemini
3. 交叉验证方案
4. 生成实施计划

**输出**：经过验证的实施计划

**为什么重要**：多模型交叉验证，降低设计缺陷风险。

---

### Phase 3：原型获取

**命令**：`/cm:implement`（自动执行）

**任务**：
- 前端/UI → Gemini
- 后端/逻辑 → Codex
- 返回 Unified Diff Patch

**输出**：原型代码

**为什么重要**：让专业模型做专业的事。

---

### Phase 4：编码实施

**命令**：`/cm:implement`

**任务**：
- 基于原型重构为企业级代码
- 每 3-5 个文件检查上下文
- 自动监控使用率

**约束**：
- 非必要不生成注释
- 仅修改需求范围
- 审查副作用

**输出**：生产级代码

**为什么重要**：确保代码符合项目标准。

---

### Phase 4.5：上下文管理与状态保存

**命令**：`/cm:save-state`（或自动触发）

**使用率分级**：
- < 50%：继续工作
- 50-70%：提示注意
- 70-85%：准备保存
- > 85%：立即保存并建议 `/clear`

**任务**：
- 保存会话状态
- 记录进度和计划
- 生成恢复提示词

**输出**：`.claude/state/current-session.md`

**为什么重要**：避免上下文溢出导致工作丢失。

---

### Phase 5：审计与交付

**命令**：`/cm:audit`

**任务**：
1. 恢复上下文（如果执行了 `/clear`）
2. Codex 和 Gemini 同时审计（并行）
3. 整合反馈并修正
4. 最终检查

**输出**：审计报告 + 最终代码

**为什么重要**：双模型审计是质量保障的最后防线。

---

## 使用指南

### 场景 1：新功能开发

```bash
# 1. 启动工作流
/cm:start

# 2. 分析需求
/cm:analyze 实现用户认证功能，支持邮箱和手机号登录

# 3. 实施开发
/cm:implement

# 4. 审计交付
/cm:audit
```

### 场景 2：Bug 修复

```bash
# 1. 快速检查
/cm:check

# 2. 启动工作流
/cm:start

# 3. 分析问题
/cm:analyze 修复支付回调处理中的并发问题

# 4. 实施修复
/cm:implement

# 5. 审计交付
/cm:audit
```

### 场景 3：长时间开发

```bash
# 开发过程中自动监控
# 当使用率达到 85%，自动提示保存

# 执行 /clear 后恢复：
"请阅读 .claude/state/current-session.md 了解之前的进度，继续工作"
```

### 最佳实践

#### 任务开始前
- ✅ 检查上下文使用率（< 50%）
- ✅ 明确任务需求和范围
- ✅ 确保代码索引已初始化

#### 任务进行中
- ✅ 信任 Context Monitor 的自动提醒
- ✅ 使用自然语言搜索代码
- ✅ 让外部模型提供原型，Claude 负责重构
- ✅ 每完成一个阶段检查使用率

#### 高使用率时
- ✅ 立即保存会话状态
- ✅ 执行 `/clear` 清除上下文
- ✅ 使用状态文件恢复
- ✅ 不要等到 100% 才清除

#### 代码质量保证
- ✅ 外部模型代码仅作原型参考
- ✅ 最终代码必须由 Claude 重构
- ✅ 强制执行双模型审计
- ✅ 精简高效，非必要不添加注释

---

## 故障排除

### 问题 1：上下文使用率检查失败

**症状**：`check_context_usage` 工具不可用

**原因**：MCP 服务器未正确配置

**解决**：
1. 检查 `.mcp.json` 是否在项目根目录
2. 重启 Claude Code
3. 运行 `/mcp list` 查看服务器状态

### 问题 2：Codex/Gemini 编码错误

**症状**：`UnicodeDecodeError` 或输出乱码

**原因**：Windows 默认编码不是 UTF-8

**解决**：参见 [编码问题解决方案](./编码问题解决方案.md)

快速修复：
```powershell
[System.Environment]::SetEnvironmentVariable("PYTHONIOENCODING", "utf-8", "User")
[System.Environment]::SetEnvironmentVariable("PYTHONUTF8", "1", "User")
```

### 问题 3：插件命令不可用

**症状**：输入 `/cm:` 没有自动补全

**原因**：插件未正确安装

**解决**：
```bash
/plugin list  # 检查是否安装
/plugin uninstall cm  # 卸载
/plugin install cm  # 重新安装
```

### 问题 4：代码索引未初始化

**症状**：`search_code_advanced` 返回空结果

**原因**：未构建深度索引

**解决**：
```bash
# 在 Claude Code 中运行
set_project_path /path/to/project
build_deep_index
configure_file_watcher enabled=true
```

### 问题 5：Skills 调用失败

**症状**：Codex/Gemini 返回错误

**原因**：Skills 未安装或配置错误

**解决**：
```bash
/skill list  # 检查已安装的 skills
/skill install collaborating-with-codex
/skill install collaborating-with-gemini
```

### 问题 6：Windows Hooks 不执行

**症状**：SessionStart hook 没有触发

**原因**：Claude Code 在 Windows 上的已知 bug（Issue #14219）

**解决**：使用插件命令代替 hooks，或在 CLAUDE.md 中添加强制指令

---

## 常见问题

### Q: 插件和项目级安装有什么区别？

A:
- **插件安装**：快速简单，适合个人使用，命令通过 `/cm:` 调用
- **项目级安装**：完全控制，适合团队协作，需要手动配置 MCP 服务器

### Q: 必须使用 Codex 和 Gemini 吗？

A: 不是必须的。如果不使用外部模型，Phase 2 和 Phase 3 会跳过，直接由 Claude 完成所有工作。但多模型协作能显著提升代码质量。

### Q: 上下文保存后如何恢复？

A: 执行 `/clear` 后，使用以下提示词：
```
请阅读 .claude/state/current-session.md 了解之前的进度，继续工作
```

### Q: 可以自定义工作流吗？

A: 可以。修改 `commands/*.md` 文件来自定义每个阶段的行为。

### Q: 支持哪些编程语言？

A: Code Index 支持主流编程语言（Python, JavaScript, TypeScript, Java, Go, Rust 等）。具体支持列表参见 Code Index MCP 文档。

---

## 更新日志

### v1.0.2 (2025-12-18)
- 将插件名改为 "cm" 以支持短命令
- 添加编码问题解决方案
- 整合文档结构

### v1.0.1 (2025-12-18)
- 修复 plugin.json 格式问题
- 添加 marketplace.json

### v1.0.0 (2025-12-17)
- 初始发布
- 完整的 6 阶段工作流
- 插件系统
- MCP 服务器集成

---

## 资源链接

- **GitHub**: https://github.com/wuciqiang/context-monitor
- **问题反馈**: https://github.com/wuciqiang/context-monitor/issues
- **Claude Code 文档**: https://docs.anthropic.com/claude-code
- **MCP 协议**: https://modelcontextprotocol.io

---

**许可证**: MIT
**作者**: Context Monitor Team
**最后更新**: 2025-12-18
