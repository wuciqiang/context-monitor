# Codex/Gemini 编码问题解决方案

## 问题描述

在 Windows 环境下使用 Codex 和 Gemini skills 时，遇到中文编码错误：
- Codex: `UnicodeDecodeError` 或 `UnicodeEncodeError`
- Gemini: 输出乱码或无法读取中文文件

## 根本原因

Windows 默认使用 GBK/CP1252 编码，而不是 UTF-8。Python 脚本在读写文件或处理标准输入输出时，如果没有显式指定 UTF-8，就会使用系统默认编码。

## 解决方案

### 方案 1：项目级环境变量配置（推荐）

在项目的 `.claude/settings.local.json` 中添加：

```json
{
  "env": {
    "PYTHONIOENCODING": "utf-8",
    "PYTHONUTF8": "1"
  }
}
```

**优点**：
- 只影响当前项目
- 不需要管理员权限
- 立即生效（重启 Claude Code）

**缺点**：
- 每个项目都需要配置

### 方案 2：全局环境变量（一劳永逸）

#### Windows PowerShell（普通用户权限）

```powershell
# 设置用户级环境变量
[System.Environment]::SetEnvironmentVariable("PYTHONIOENCODING", "utf-8", "User")
[System.Environment]::SetEnvironmentVariable("PYTHONUTF8", "1", "User")
```

#### 或使用提供的脚本

```powershell
# 以管理员权限运行
.\fix-encoding.ps1
```

**优点**：
- 一次配置，所有项目生效
- 解决所有 Python 相关的编码问题

**缺点**：
- 需要重启系统（如果修改注册表）
- 影响全局环境

### 方案 3：Windows 系统区域设置

1. 打开 **控制面板** > **区域**
2. 点击 **管理** 标签
3. 点击 **更改系统区域设置**
4. 勾选 **Beta: 使用 Unicode UTF-8 提供全球语言支持**
5. 重启计算机

**优点**：
- 系统级解决方案，彻底解决编码问题
- 对所有应用程序生效

**缺点**：
- 需要重启计算机
- 可能影响某些老旧软件的兼容性

### 方案 4：修改 Skills 桥接脚本（高级）

如果上述方案都不行，可能需要修改 skills 的 Python 脚本。

找到 skills 目录：
```
C:\Users\admin\.claude\skills\collaborating-with-codex\scripts\codex_bridge.py
C:\Users\admin\.claude\skills\collaborating-with-gemini\scripts\gemini_bridge.py
```

在脚本开头添加：

```python
import sys
import io

# 强制使用 UTF-8 编码
sys.stdin = io.TextIOWrapper(sys.stdin.buffer, encoding='utf-8')
sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')
```

**优点**：
- 针对性强，直接修复问题源头

**缺点**：
- 需要手动修改第三方代码
- Skills 更新后可能被覆盖

## 推荐实施顺序

1. **立即生效**：方案 1（项目级环境变量）
2. **长期方案**：方案 2（全局环境变量）或方案 3（系统设置）
3. **最后手段**：方案 4（修改脚本）

## 验证修复

配置完成后，重启 Claude Code，然后测试：

```bash
# 测试 Codex
/cm:analyze 实现一个简单的中文分词功能

# 测试 Gemini
/cm:analyze 设计一个包含中文标签的用户界面
```

如果不再出现编码错误，说明修复成功。

## 常见问题

### Q: 设置环境变量后仍然报错？
A: 确保完全重启了 Claude Code（不是刷新，是完全退出后重新启动）。

### Q: 修改注册表后系统出现问题？
A: 可以恢复注册表设置：
```powershell
$registryPath = "HKLM:\SYSTEM\CurrentControlSet\Control\Nls\CodePage"
Set-ItemProperty -Path $registryPath -Name "ACP" -Value "936"  # GBK
Set-ItemProperty -Path $registryPath -Name "OEMCP" -Value "936"
```

### Q: 能否只修复 Codex/Gemini，不影响其他工具？
A: 可以在调用 skills 时临时设置环境变量，但这需要修改 Context Monitor 插件的命令文件。

## 更新 Context Monitor 文档

建议在工作流介绍中添加"Windows 环境配置"章节，说明编码问题和解决方案。

---

**最后更新**：2025-12-18
