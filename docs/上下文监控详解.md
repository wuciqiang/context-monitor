# ä¸Šä¸‹æ–‡ç›‘æ§ç³»ç»Ÿ
# Context Monitoring System

> åŠè‡ªåŠ¨åŒ–çš„ Claude Code ä¸Šä¸‹æ–‡ä½¿ç”¨ç‡ç›‘æ§æ–¹æ¡ˆ

---

## ğŸ“Š ç³»ç»Ÿæ¦‚è¿°

æœ¬ç³»ç»Ÿé€šè¿‡ **Hook + MCP Server + CLAUDE.md æŒ‡ä»¤** çš„ç»„åˆï¼Œå®ç°å¯¹ Claude Code ä¼šè¯ä¸Šä¸‹æ–‡ä½¿ç”¨ç‡çš„åŠè‡ªåŠ¨ç›‘æ§ã€‚

### æ ¸å¿ƒç»„ä»¶

1. **SessionStart Hook** - æ•è·ä¼šè¯ä¿¡æ¯ï¼ˆtranscript è·¯å¾„ï¼‰
2. **Context Monitor MCP Server** - æä¾›ç›‘æ§å·¥å…·
3. **CLAUDE.md æŒ‡ä»¤** - æŒ‡å¯¼ Claude å®šæœŸæ£€æŸ¥å’Œå“åº”

### å·¥ä½œæµç¨‹

```
ä¼šè¯å¼€å§‹
  â†“
SessionStart Hook æ•è· transcript_path
  â†“
å†™å…¥ /tmp/claude-session-info.json
  â†“
Claude æ¯ 5-10 ä¸ªå·¥å…·è°ƒç”¨å
  â†“
è°ƒç”¨ check_context_usage å·¥å…·
  â†“
MCP Server è¯»å– transcript æ–‡ä»¶å¤§å°
  â†“
è®¡ç®—ä½¿ç”¨ç‡å¹¶è¿”å›çŠ¶æ€
  â†“
Claude æ ¹æ®ä½¿ç”¨ç‡é‡‡å–è¡ŒåŠ¨ï¼š
  - < 50%: ç»§ç»­å·¥ä½œ
  - 50-70%: æ³¨æ„ä½¿ç”¨ç‡
  - 70-85%: å‡†å¤‡ä¿å­˜çŠ¶æ€
  - > 85%: ç«‹å³ä¿å­˜å¹¶æç¤ºç”¨æˆ· /clear
```

---

## ğŸš€ å®‰è£…é…ç½®

### 1. æ–‡ä»¶ç»“æ„

ç¡®ä¿ä»¥ä¸‹æ–‡ä»¶å­˜åœ¨ï¼š

```
.claude/
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ capture-session-info.sh       # SessionStart hook
â”œâ”€â”€ mcp-servers/
â”‚   â””â”€â”€ context-monitor/
â”‚       â””â”€â”€ server.py                  # MCP server
â””â”€â”€ settings.local.json                # Hook å’Œ MCP é…ç½®
```

### 2. èµ‹äºˆæ‰§è¡Œæƒé™

```bash
chmod +x .claude/hooks/capture-session-info.sh
chmod +x .claude/mcp-servers/context-monitor/server.py
```

**æ³¨æ„**: æ‰€æœ‰æ–‡ä»¶éƒ½åœ¨ `.claude` ç›®å½•ä¸‹ï¼Œä¿æŒé¡¹ç›®æ ¹ç›®å½•æ•´æ´ã€‚

### 3. éªŒè¯é…ç½®

æ£€æŸ¥ `.claude/settings.local.json`ï¼š

```json
{
  "hooks": {
    "SessionStart": [
      {
        "matcher": "startup|resume",
        "hooks": [
          {
            "type": "command",
            "command": "bash \"$CLAUDE_PROJECT_DIR/.claude/hooks/capture-session-info.sh\"",
            "timeout": 5
          }
        ]
      }
    ]
  },
  "mcpServers": {
    "context-monitor": {
      "command": "python3",
      "args": [".claude/mcp-servers/context-monitor/server.py"],
      "env": {}
    }
  }
}
```

**è¯´æ˜**:
- `matcher: "startup|resume"` - åœ¨æ–°ä¼šè¯å¯åŠ¨æˆ–æ¢å¤ä¼šè¯æ—¶éƒ½è¿è¡Œ hook
- Hook ä½¿ç”¨ `$CLAUDE_PROJECT_DIR` ç¯å¢ƒå˜é‡å¼•ç”¨é¡¹ç›®æ ¹ç›®å½•
- MCP server ä½¿ç”¨ç›¸å¯¹è·¯å¾„ `.claude/mcp-servers/...`

---

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### è‡ªåŠ¨å¯åŠ¨

å½“ä½ å¯åŠ¨ Claude Code ä¼šè¯æ—¶ï¼š
1. SessionStart hook è‡ªåŠ¨è¿è¡Œ
2. ä¼šè¯ä¿¡æ¯è¢«æ•è·åˆ° `/tmp/claude-session-info.json`
3. Context Monitor MCP Server è‡ªåŠ¨åŠ è½½
4. Claude ä¼šçœ‹åˆ°æç¤ºï¼š"ğŸ“Š Context monitoring active"

### æ‰‹åŠ¨æ£€æŸ¥

åœ¨å¯¹è¯ä¸­ï¼Œä½ å¯ä»¥éšæ—¶è¦æ±‚ Claude æ£€æŸ¥ï¼š

```
è¯·æ£€æŸ¥å½“å‰ä¸Šä¸‹æ–‡ä½¿ç”¨ç‡
```

Claude ä¼šè°ƒç”¨ `check_context_usage` å·¥å…·å¹¶æŠ¥å‘Šç»“æœã€‚

### Claude çš„è‡ªåŠ¨è¡Œä¸º

æ ¹æ® CLAUDE.md ä¸­çš„æŒ‡ä»¤ï¼ŒClaude ä¼šï¼š
- æ¯ 5-10 ä¸ªå·¥å…·è°ƒç”¨åè‡ªåŠ¨æ£€æŸ¥
- æ ¹æ®ä½¿ç”¨ç‡é‡‡å–ç›¸åº”è¡ŒåŠ¨
- åœ¨é«˜ä½¿ç”¨ç‡æ—¶ä¸»åŠ¨ä¿å­˜çŠ¶æ€å¹¶æç¤ºä½ æ‰§è¡Œ `/clear`

---

## ğŸ“ˆ MCP å·¥å…·è¯´æ˜

### 1. check_context_usage

**åŠŸèƒ½**ï¼šæ£€æŸ¥å½“å‰ä¼šè¯çš„ä¸Šä¸‹æ–‡ä½¿ç”¨ç‡

**è¾“å…¥**ï¼šæ— å‚æ•°

**è¾“å‡º**ï¼š
```json
{
  "session_id": "abc123",
  "transcript_path": "/path/to/transcript.jsonl",
  "file_size_mb": 3.45,
  "estimated_tokens": 45000,
  "usage_percent": 22.5,
  "max_tokens": 200000,
  "status": "âœ… SAFE",
  "recommendation": "Context usage is healthy. Continue working normally.",
  "timestamp": "2025-12-16T10:30:00Z"
}
```

**çŠ¶æ€çº§åˆ«**ï¼š
- `âœ… SAFE` (< 50%)
- `âš ï¸ WARNING` (50-70%)
- `ğŸ”´ HIGH` (70-85%)
- `ğŸš¨ CRITICAL` (> 85%)

### 2. save_session_state

**åŠŸèƒ½**ï¼šä¿å­˜ä¼šè¯çŠ¶æ€åˆ° `.claude/state/current-session.md`

**è¾“å…¥**ï¼š
```json
{
  "content": "å½“å‰è¿›åº¦æè¿°",
  "next_steps": "ä¸‹ä¸€æ­¥è¦åšä»€ä¹ˆ"
}
```

**è¾“å‡º**ï¼š
```json
{
  "success": true,
  "state_file": ".claude/state/current-session.md",
  "message": "Session state saved successfully"
}
```

---

## âš ï¸ é‡è¦è¯´æ˜

### é™åˆ¶

1. **æ— æ³•è‡ªåŠ¨æ‰§è¡Œ /clear** - è¿™æ˜¯ Claude Code çš„æ¶æ„é™åˆ¶ï¼Œå¿…é¡»ç”±ç”¨æˆ·æ‰‹åŠ¨æ‰§è¡Œ
2. **Token ä¼°ç®—ä¸ç²¾ç¡®** - ä½¿ç”¨æ–‡ä»¶å¤§å°ä¼°ç®—ï¼Œå¯èƒ½æœ‰ Â±10% çš„è¯¯å·®
3. **éœ€è¦ Python 3** - MCP server éœ€è¦ Python 3 ç¯å¢ƒ
4. **macOS/Linux ä¼˜å…ˆ** - Windows å¯èƒ½éœ€è¦è°ƒæ•´è„šæœ¬

### æœ€ä½³å®è·µ

1. **ä¿¡ä»» Claude çš„åˆ¤æ–­** - å½“ Claude æç¤ºä¿å­˜çŠ¶æ€æ—¶ï¼Œç«‹å³æ‰§è¡Œ
2. **å®šæœŸæ£€æŸ¥** - åœ¨é•¿æ—¶é—´ä¼šè¯ä¸­ï¼Œä¸»åŠ¨è¦æ±‚ Claude æ£€æŸ¥ä½¿ç”¨ç‡
3. **åŠæ—¶æ¸…é™¤** - ä¸è¦ç­‰åˆ° 100% æ‰æ¸…é™¤ï¼Œ70-80% å°±åº”è¯¥è€ƒè™‘
4. **ä¿å­˜å®Œæ•´çŠ¶æ€** - ç¡®ä¿ `save_session_state` åŒ…å«è¶³å¤Ÿçš„ä¿¡æ¯ä»¥ä¾¿æ¢å¤

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šHook æ²¡æœ‰è¿è¡Œ

**æ£€æŸ¥**ï¼š
```bash
# æŸ¥çœ‹ hook æ˜¯å¦æœ‰æ‰§è¡Œæƒé™
ls -l .claude/hooks/capture-session-info.sh

# æ‰‹åŠ¨æµ‹è¯• hook
echo '{"session_id":"test","transcript_path":"/tmp/test.jsonl","cwd":"."}' | bash .claude/hooks/capture-session-info.sh
```

### é—®é¢˜ï¼šMCP Server æ— æ³•å¯åŠ¨

**æ£€æŸ¥**ï¼š
```bash
# æµ‹è¯• Python ç¯å¢ƒ
python3 --version

# æ‰‹åŠ¨è¿è¡Œ server
python3 .claude/mcp-servers/context-monitor/server.py
```

### é—®é¢˜ï¼šcheck_context_usage è¿”å›é”™è¯¯

**æ£€æŸ¥**ï¼š
```bash
# æŸ¥çœ‹ä¼šè¯ä¿¡æ¯æ–‡ä»¶
cat /tmp/claude-session-info.json

# æ£€æŸ¥ transcript æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -lh ~/.claude/transcripts/
```

### é—®é¢˜ï¼šä½¿ç”¨ç‡è®¡ç®—ä¸å‡†ç¡®

**è¯´æ˜**ï¼š
- ä½¿ç”¨æ–‡ä»¶å¤§å°ä¼°ç®— token æ•°é‡ï¼ˆ1 token â‰ˆ 4 bytesï¼‰
- è¿™æ˜¯ç²—ç•¥ä¼°ç®—ï¼Œå®é™…å¯èƒ½æœ‰åå·®
- å»ºè®®åœ¨ 60-70% æ—¶å°±å¼€å§‹å‡†å¤‡æ¸…é™¤

---

## ğŸ”„ æ¢å¤ä¼šè¯

å½“ä½ æ‰§è¡Œ `/clear` åï¼Œä½¿ç”¨ä»¥ä¸‹æç¤ºè¯æ¢å¤ï¼š

```
è¯·é˜…è¯» .claude/state/current-session.md äº†è§£ä¹‹å‰çš„è¿›åº¦ï¼Œç„¶åç»§ç»­å·¥ä½œã€‚
```

Claude ä¼šï¼š
1. è¯»å–çŠ¶æ€æ–‡ä»¶
2. äº†è§£ä¹‹å‰çš„è¿›åº¦
3. ç»§ç»­æœªå®Œæˆçš„ä»»åŠ¡

---

## ğŸ“š æŠ€æœ¯ç»†èŠ‚

### Token ä¼°ç®—å…¬å¼

```python
estimated_tokens = file_size_bytes / 4
usage_percent = (estimated_tokens / 200000) * 100
```

### ä¸ºä»€ä¹ˆæ˜¯ 200,000 tokensï¼Ÿ

- Claude Sonnet 4.5 çš„ä¸Šä¸‹æ–‡çª—å£æ˜¯ 200k tokens
- å®é™…å¯ç”¨å¯èƒ½ç•¥å°‘ï¼ˆç³»ç»Ÿæç¤ºè¯å ç”¨ï¼‰
- å»ºè®®åœ¨ 70-80% æ—¶æ¸…é™¤ä»¥ä¿æŒå®‰å…¨è¾¹é™…

### ä¼šè¯ä¿¡æ¯æ–‡ä»¶æ ¼å¼

```json
{
  "session_id": "å”¯ä¸€ä¼šè¯ ID",
  "transcript_path": "transcript æ–‡ä»¶çš„ç»å¯¹è·¯å¾„",
  "cwd": "å½“å‰å·¥ä½œç›®å½•",
  "timestamp": "ISO 8601 æ—¶é—´æˆ³"
}
```

---

## ğŸ¯ æœªæ¥æ”¹è¿›

å¯èƒ½çš„å¢å¼ºæ–¹å‘ï¼š

1. **æ›´ç²¾ç¡®çš„ token è®¡ç®—** - ä½¿ç”¨ tiktoken åº“ç²¾ç¡®è®¡ç®—
2. **å¯è§†åŒ–ä»ªè¡¨æ¿** - Web UI æ˜¾ç¤ºå®æ—¶ä½¿ç”¨ç‡
3. **è‡ªåŠ¨å¤‡ä»½** - å®šæœŸè‡ªåŠ¨ä¿å­˜çŠ¶æ€
4. **å¤šä¼šè¯æ”¯æŒ** - è·Ÿè¸ªå¤šä¸ªå¹¶è¡Œä¼šè¯
5. **å†å²åˆ†æ** - åˆ†æå†å²ä½¿ç”¨æ¨¡å¼

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š
1. æ£€æŸ¥æœ¬æ–‡æ¡£çš„æ•…éšœæ’æŸ¥éƒ¨åˆ†
2. æŸ¥çœ‹ `.claude/logs/` ä¸­çš„æ—¥å¿—
3. åœ¨é¡¹ç›®ä¸­åˆ›å»º Issue

---

**ç‰ˆæœ¬**: 1.0.0
**æœ€åæ›´æ–°**: 2025-12-16
**ç»´æŠ¤è€…**: Project Team
